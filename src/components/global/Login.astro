<section x-data="loginForm()">
  <div class="max-w-xl mx-auto px-8 py-12 lg:py-32">
    <div class="prose-styles">
      <h1 x-text="emailSent ? 'Check Your Inbox' : 'Sign in with your email'">
      </h1>
      <p x-cloak x-show="!emailSent">
        Please enter the email address linked to your account, and we will send
        a unique sign-in link to your inbox.
      </p>
      <p x-cloak x-show="emailSent">
        Please click the link in the email we sent to sign in to your account.
        If you can't find the email, be sure to check your spam folder.
      </p>
    </div>
    <form
      @submit.prevent="sendEmail()"
      x-cloak
      x-show="!emailSent || errorMessage"
    >
      <div class="space-y-3 mt-6 pt-6 border-t">
        <div>
          <label for="email" class="sr-only"> Email </label>
          <input
            id="email"
            name="email"
            type="email"
            x-model="email"
            x-on:input="clearErrorMessage"
            autocomplete="on"
            placeholder="email@example.com"
            required
            aria-required="true"
            class="block w-full px-4 py-2 h-10 border-2 focus:ring-2 focus:ring-blue-500 bg-chalk border-transparent ring-1 ring-gray-200 duration-300 rounded-lg appearance-none text-blue-500 placeholder-zinc-300 focus:border-blue-300 focus:outline-none sm:text-sm"
          />
          <div class="mt-4 space-y-2 text-xs text-gray-500">
            <div x-cloak x-show="!!errorMessage">
              <p x-text="errorMessage"></p>
            </div>
          </div>
        </div>
        <div class="space-y-3">
          <button
            type="submit"
            aria-label="Get your link"
            class="rounded-lg px-4 py-2 text-sm font-semibold w-full transition-all text-white bg-gradient-to-b from-blue-500 to-blue-600 hover:to-blue-700 h-10 inline-flex items-center justify-between"
          >
            Get your link
            <span aria-hidden="true">&rarr;</span>
          </button>
          <div class="prose-styles">
            <small
              >By clicking continue, you agree to our <a href="/terms"
                >Terms of Service</a
              > and
              <a href="/privacy"> Privacy Policy. </a>
            </small>
          </div>
        </div>
      </div>
    </form>
    <div x-cloak x-show="emailSent">
      <div class="prose-styles">
        <p>
          Didn't receive the email?
          <button
            class="rounded-lg mt-6 px-4 py-2 text-sm font-semibold w-full transition-all text-white bg-gradient-to-b from-blue-500 to-blue-600 hover:to-blue-700 h-10 inline-flex items-center justify-between"
            @click="clearForm()"
          >
            Try again
          </button>
        </p>
      </div>
    </div>
  </div>
</section>
<script>
  import Alpine from "alpinejs";
  import { sendSignInLinkToEmail } from "firebase/auth";
  import { auth } from "@/firebase/client";

  document.addEventListener("alpine:init", () => {
    Alpine.data("loginForm", () => ({
      email: "",
      emailSent: false,
      errorMessage: "",
      clearErrorMessage() {
        this.errorMessage = "";
      },
      clearForm() {
        this.email = "";
        this.emailSent = false;
        this.errorMessage = "";
      },
      async sendEmail() {
        const baseUrl = import.meta.env.PUBLIC_APP_BASE_URL;

        const actionCodeSettings = {
          url: `${baseUrl}/email-signin`,
          handleCodeInApp: true,
        };

        try {
          window.localStorage.setItem("emailForSignIn", this.email);

          await sendSignInLinkToEmail(auth, this.email, actionCodeSettings);

          this.emailSent = true;
        } catch (error) {
          console.log("error", error.code, error.message);
          if (error.code === "auth/admin-restricted-operation") {
            console.log("error auth/admin-restricted-operation");
            this.errorMessage = [
              "We couldn't find an account linked to this email address.",
              "Please check the email address or create a new account.",
            ].join(" ");
          } else {
            console.log("error else");
            this.errorMessage = [
              "We were unable to send the sign-in link to your email.",
              "Please check your email address and try again.",
            ].join(" ");
          }
        }
      },
    }));
  });
</script>
